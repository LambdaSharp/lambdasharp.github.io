<!DOCTYPE html>
<html lang="en">
  
  <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-147535443-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-147535443-1');
    </script>
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="LambdaSharp.Core Log Records - CloudWatch Log Events converted by LambdaSharp.Core - LambdaSharp | LambdaSharp - Serverless .NET for AWS">
    <meta name="description" content="Description of S3 Log Records generated by processing CloudWatch Log events">
    <meta name="keywords" content="cloudwatch, records, logs, modules, lambdasharp, lambda sharp, aws, serverless, .net, dotnet, .net core, dotnetcore, c#, c sharp">
    <meta name="generator" content="docfx 2.53.1.0">
    <meta name="robots" content="index,follow">
  
    <meta property="og:title" content="LambdaSharp.Core Log Records - CloudWatch Log Events converted by LambdaSharp.Core - LambdaSharp | LambdaSharp - Serverless .NET for AWS">
    <meta property="og:site_name" content="LambdaSharp - Serverless .NET for AWS">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en_US">
    <meta property="og:url" content="https://lambdasharp.net/articles/LogRecords.html">
    <meta property="og:image" content="https://lambdasharp.net/images/LambdaSharpBadge.png">
    <meta property="og:description" content="Description of S3 Log Records generated by processing CloudWatch Log events">
  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="LambdaSharp.Core Log Records - CloudWatch Log Events converted by LambdaSharp.Core - LambdaSharp | LambdaSharp - Serverless .NET for AWS">
    <meta name="twitter:site" content="@lambdasharp">
    <meta name="twitter:description" content="Description of S3 Log Records generated by processing CloudWatch Log events">
    <meta name="twitter:image" content="https://lambdasharp.net/images/LambdaSharpBadge.png">
  
    <link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
  
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:newtab" content="true">
  
    <title>LambdaSharp.Core Log Records - CloudWatch Log Events converted by LambdaSharp.Core - LambdaSharp | LambdaSharp - Serverless .NET for AWS </title>
    <link rel="canonical" href="https://lambdasharp.net/articles/LogRecords.html">
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../images/LambdaSharpLogo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="s3-log-records">S3 Log Records</h1>

<p>All ingested CloudWatch Log events are stored in an S3 logging bucket when <em>Core Services</em> are enabled. During ingestion, the <em>LambdaSharp.Core</em> module parses and converts the CloudWatch Log events into JSON records. This enables <a href="https://aws.amazon.com/athena/">Amazon Athena</a> to query the ingested CloudWatch Log events.</p>
<h2 id="record-schema">Record Schema</h2>
<p>The log record schema has the following fields.</p>
<pre><code class="lang-yaml">Timestamp: Long
ModuleInfo: String
Module: String
ModuleId: String
Function: String
FunctionId: String
Tier: String
RecordType: String
Record: String
</code></pre>
<h2 id="record-properties">Record Properties</h2>
<dl>
<dt><code>Timestamp</code></dt>
<dd>
<p>The <code>Timestamp</code> property holds the UNIX epoch timestamp in milliseconds.</p>
<p><i>Type</i>: Long</p>
</dd>
<dt><code>ModuleInfo</code></dt>
<dd>
<p>The <code>ModuleInfo</code> property holds the module name, version, and origin information.</p>
<p><i>Type</i>: String</p>
</dd>
<dt><code>Module</code></dt>
<dd>
<p>The <code>Module</code> property holds the module name.</p>
<p><i>Type</i>: String</p>
</dd>
<dt><code>ModuleId</code></dt>
<dd>
<p>The <code>ModuleId</code> property holds the CloudFormation stack name.</p>
<p><i>Type</i>: String</p>
</dd>
<dt><code>Function</code></dt>
<dd>
<p>The <code>Function</code> property holds the logical Lambda function name.</p>
<p><i>Type</i>: String</p>
</dd>
<dt><code>FunctionId</code></dt>
<dd>
<p>The <code>FunctionId</code> property holds the Lambda function resource name.</p>
<p><i>Type</i>: String</p>
</dd>
<dt><code>Tier</code></dt>
<dd>
<p>The <code>Tier</code> property holds the deployment tier name.</p>
<p><i>Type</i>: String</p>
</dd>
<dt><code>RecordType</code></dt>
<dd>
<p>The <code>RecordType</code> property holds the type of log record. Must be one of <code>LambdaError</code>, <code>LambdaEvent</code>, <code>LambdaMetrics</code>, or <code>UsageReport</code>.</p>
<p><i>Type</i>: String</p>
</dd>
<dt><code>Record</code></dt>
<dd>
<p>The <code>Record</code> property holds the contents of the log record as a serialized JSON string.</p>
<p><i>Type</i>: String</p>
</dd>
</dl>
<h2 id="athena-table">Athena Table</h2>
<p>The following steps show how to setup an Athena database and table to query ingested CloudWatch Log events.</p>
<h3 id="step-1---create-an-athena-database">Step 1 - Create an Athena Database</h3>
<p>If you haven't already done so, create an Athena database. Replace <code>MyDatabase</code> with a database name of your choice.</p>
<pre><code class="lang-sql">CREATE DATABASE MyDatabase;
</code></pre>
<h3 id="step-2---create-an-athena-table">Step 2 - Create an Athena Table</h3>
<p>Replace <code>&lt;LOGGING-BUCKET&gt;</code> with the S3 logging bucket name. The S3 logging bucket name can be found in the output of the <code>lash init</code> command or, anytime later, in the AWS console. To find the bucket name in the AWS console, got to the <em>CloudFormation</em> service, select the <em>LambdaSharp.Core</em> CloudFormation stack corresponding to the deployment tier, and select <em>Outputs</em> on the tabbed view. The ARN of the S3 logging bucket is under the <code>LoggingBucket</code> output value. Note that the part after the last colon (<code>:</code>) is the bucket name.</p>
<p>By default, the log records are stored under the <code>logging-success/</code> prefix. Adjust the prefix according to your configuration.</p>
<p>Finally, replace <code>MyLogs</code> with a table name of your choice.</p>
<pre><code class="lang-sql">CREATE EXTERNAL TABLE IF NOT EXISTS MyDatabase.MyLogs (
  `Timestamp` bigint,
  `ModuleInfo` string,
  `Module` string,
  `ModuleId` string,
  `Function` string,
  `FunctionId` string,
  `Record` string,
  `RecordType` string
)
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'
WITH SERDEPROPERTIES (
  'serialization.format' = '1'
) LOCATION 's3://&lt;LOGGING-BUCKET&gt;/logging-success/';
</code></pre>
<h3 id="step-3---query-log-records-from-athena">Step 3 - Query Log Records from Athena</h3>
<p>The following query fetches all log records for all modules and functions from the S3 logging bucket.</p>
<p>Make sure to replace <code>MyDatabase</code> and <code>MyLogs</code> with your database and table names, respectively.</p>
<pre><code class="lang-sql">SELECT *
FROM MyDatabase.MyLogs
ORDER BY Timestamp DESC;
</code></pre>
<h3 id="example-1-show-usage-reports-by-used-duration">Example 1: Show Usage Reports by Used Duration</h3>
<p>The following query summarizes all <code>UsageReport</code> records by count, average used duration in percent, and maximum used duration in percent. This query is useful to identify Lambda functions that may be running too close to their execution limit.</p>
<p>Make sure to replace <code>MyDatabase</code> and <code>MyLogs</code> with your database and table names, respectively.</p>
<pre><code class="lang-sql">SELECT
  Module,
  Function,
  Count(UsedDurationPercent) AS Count,
  Round(Avg(UsedDurationPercent), 2) AS AvgUsedDurationPercent,
  Round(Max(UsedDurationPercent), 2) AS MaxUsedDurationPercent
FROM (
  SELECT
    Module,
    Function,
    (100.0 * Cast(json_extract_scalar(Record, '$.UsedDurationPercent') AS REAL)) AS UsedDurationPercent
  FROM MyDatabase.MyLogs
  WHERE RecordType = 'UsageReport'
)
GROUP BY 1, 2
ORDER BY 5 DESC;
</code></pre>
<table>
<thead>
<tr>
<th>Module</th>
<th>Function</th>
<th>Count</th>
<th>AvgUsedDurationPercent</th>
<th>MaxUsedDurationPercent</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sample.Event</td>
<td>SenderFunction</td>
<td>10</td>
<td>6.82</td>
<td>16.93</td>
</tr>
<tr>
<td>Sample.Metric</td>
<td>MyFunction</td>
<td>4</td>
<td>2.02</td>
<td>8.07</td>
</tr>
<tr>
<td>Sample.Event</td>
<td>ReceiverFunction</td>
<td>10</td>
<td>6.08</td>
<td>7.84</td>
</tr>
</tbody>
</table>
<h3 id="example-2-show-lambdaerror-reports-for-past-24-hours">Example 2: Show LambdaError Reports for past 24 Hours</h3>
<p>The following query shows all LambdaError reports for the past 24 hours by CloudFormation stack (<code>moduleId</code>) and Lambda function.</p>
<p>Make sure to replace <code>MyDatabase</code> and <code>MyLogs</code> with your database and table names, respectively.</p>
<pre><code class="lang-sql">SELECT
  from_unixtime(Timestamp / 1000.0) AS &quot;DateTime (UTC)&quot;,
  ModuleId,
  Function,
  json_extract_scalar(Record, '$.Level') AS Level,
  json_extract_scalar(Record, '$.Message') AS Message
FROM MyDatabase.MyLogs
WHERE Timestamp &gt; (1000.0 * to_unixtime(date_add('day', -1, now()))) AND RecordType='LambdaError'
ORDER BY Timestamp DESC, ModuleId, Function
</code></pre>
<table>
<thead>
<tr>
<th>DateTime</th>
<th>ModuleId</th>
<th>Function</th>
<th>Level</th>
<th>Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>2020-05-13 23:10:08.779</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailTimeout</td>
<td>ERROR</td>
<td>Lambda timed out after 15.02 seconds</td>
</tr>
<tr>
<td>2020-05-13 23:10:03.361</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailConstructor</td>
<td>ERROR</td>
<td>An exception was thrown when the constructor for type 'BadModule.FailConstructor.Function' was invoked. Check inner exception for more details.</td>
</tr>
<tr>
<td>2020-05-13 23:10:02.816</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailConstructor</td>
<td>ERROR</td>
<td>An exception was thrown when the constructor for type 'BadModule.FailConstructor.Function' was invoked. Check inner exception for more details.</td>
</tr>
<tr>
<td>2020-05-13 23:10:02.208</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailError</td>
<td>ERROR</td>
<td>this exception was thrown on request</td>
</tr>
<tr>
<td>2020-05-13 23:10:01.582</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailBadEntryPoint</td>
<td>ERROR</td>
<td>Unable to load type 'BadModule.FailBadEntryPoint.Function' from assembly 'FailBadEntryPoint'.</td>
</tr>
<tr>
<td>2020-05-13 23:10:01.236</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailBadEntryPoint</td>
<td>ERROR</td>
<td>Unable to load type 'BadModule.FailBadEntryPoint.Function' from assembly 'FailBadEntryPoint'.</td>
</tr>
<tr>
<td>2020-05-13 23:10:00.877</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailOutOfMemory</td>
<td>ERROR</td>
<td>Exception of type 'System.OutOfMemoryException' was thrown.</td>
</tr>
<tr>
<td>2020-05-13 23:09:59.386</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailBadEntryPoint</td>
<td>ERROR</td>
<td>Unable to load type 'BadModule.FailBadEntryPoint.Function' from assembly 'FailBadEntryPoint'.</td>
</tr>
<tr>
<td>2020-05-13 23:09:58.200</td>
<td>Sandbox-LambdaSharp-BadModule</td>
<td>FailConstructor</td>
<td>ERROR</td>
<td>An exception was thrown when the constructor for type 'BadModule.FailConstructor.Function' was invoked. Check inner exception for more details.</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>NOTE:</strong> Due to an <a href="https://github.com/aws/aws-lambda-dotnet/issues/669">issue in the Lambda runtime</a> errors that occur either in the constructor or failure to located the constructor result in multiple entries in CloudWatch Logs.</p>
</blockquote>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
